<!DOCTYPE html>
<html>

<head>
    <title>Drillinginfo Index: Rig Count</title>
    <style>
        body {
            background: aliceblue;
        }
        
        #rig-count {
            padding: 5px;
            font: 16px 'helvetica neue', sans-serif;
        }
    </style>
</head>

<body>
    <div id="rig-count"></div>

    <!-- libraries -->
    <script src="vendor.js"></script>

    <!-- handlebars templates and helpers -->
    <script id="rig-count-tpl" type="text/x-handlebars-template">
        <h1>Rig Count</h1>
        <ul>
            <li>count change: {{count_change}}</li>
            <!--li>date order: {{date_order}}</li-->
            <li>percent change: {{delta pct_change append="%"}}</li>
            <li>rig count: {{rig_count}}</li>
            <li>rig date: {{dateformat rig_date "dddd, MMMM Do YYYY"}}</li>
        </ul>
    </script>
    <script>
        // positive or negative change?
        Handlebars.registerHelper('delta', function(delta, context) {
            delta = Math.round(delta);
            if (delta >= 0) {
                return new Handlebars.SafeString('<span class="inc">' + delta + context.hash.append + '</span>');
            }

            return new Handlebars.SafeString('<span class="dec">' + delta + context.hash.append + '</span>');
        });

        // date formatting
        Handlebars.registerHelper('dateformat', function(date, format) {
            return moment(date).format(format);
        });
    </script>

    <script>
        (function() {
            var source = document.getElementById("rig-count-tpl").innerHTML;
            var template = Handlebars.compile(source);

            var request_url = "/wp-content/plugins/diindex/api-proxy.php";
            var data_url = "url=http://di-api.drillinginfo.com/v1/diindex/media_rig_count?$format=json";
            var xmlhttp = new XMLHttpRequest();

            xmlhttp.onreadystatechange = function() {
            	if(xmlhttp.readyState == 4) {
            		if(xmlhttp.status == 200) {
	            		// success
	            		response_json = JSON.parse(xmlhttp.responseText);
	            		var current = response_json.contents.elements[0];
	                    // render template
	                    document.getElementById("rig-count").innerHTML = template(current);
	                }
	                else {
	                	// failure
	               		var p = document.createElement(p);
	               		p.textContent = "Rig data is not available at this time.";
	               		document.getElementById("rig-count").appendChild(p);
	                }
            	} 
            };
            // send request
            xmlhttp.open("GET", request_url + "?" + data_url, true);
            xmlhttp.send();
        })();
    </script>
</body>
</html>